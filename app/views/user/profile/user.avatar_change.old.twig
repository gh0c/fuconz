{% extends "templates/default.twig" %}

{% block title %}
    Promjena avatara
{% endblock %}

{% block content %}

    <script type="text/javascript" src="public/js/cloudinary/jquery.ui.widget.js"></script>
    <script type="text/javascript" src="public/js/cloudinary/jquery.iframe-transport.js"></script>
    <script type="text/javascript" src="public/js/cloudinary/jquery.fileupload.js"></script>
    <script type="text/javascript" src="public/js/cloudinary/jquery.cloudinary.js"></script>
    {{ cloudinary_js_config() }}

    <div class = "main-block-cont">
        <div class = "black-horiz-spacer-10"></div>

        <div class = "main-title-box">
            <div class = "inner-cont flag"></div>
            <div class = "inner-cont page-title">
                <h1>Promjena avatara</h1>
            </div>
        </div>
        <div class = "black-horiz-spacer-5"></div>
        {{ cl_image_upload_tag('test', {"tags":"direct_photo_album",
        "public_id" : "testa/c1", "tags" : "direct_photo_album", "callback" : cors_location,
        "html" : {
        "multiple" : true,
        "class" : "gogina text-input file-input",
        "name": "avatar-file",
        "id" :"avatar-file"}
        }) }}
        <div class="status">
            <h2>Status</h2>
            <span class="status_value">Idle</span>
        </div>
        <div class="uploaded_info_holder">
        </div>
        <script>
            function prettydump(obj) {
                ret = ""
                $.each(obj, function(key, value) {
                    ret += "<tr><td>" + key + "</td><td>" + value + "</td></tr>";
                });
                return ret;
            }

            $(function() {
                $('.cloudinary-fileupload')
                        .fileupload({
                            dropZone: '#direct_upload',
                            start: function () {
                                $('.status_value').text('Starting direct upload...');
                            },
                            progress: function () {
                                $('.status_value').text('Uploading...');
                            },
                        })
                        .on('cloudinarydone', function (e, data) {
                            $('.status_value').text('Idle');
//                            $.post('upload_complete.php', data.result);
                            var info = $('<div class="uploaded_info"/>');
                            $(info).append($('<div class="data"/>').append(prettydump(data.result)));
                            $(info).append($('<div class="image"/>').append(
                                    $.cloudinary.image(data.result.public_id, {
                                        format: data.result.format, width: 150, height: 150, crop: "fill"
                                    })
                            ));
                            $('.uploaded_info_holder').append(info);
                        });
            });
        </script>


        <div class = "main-content-box">
            <div class = "inner-cont">
                <div class = "form-container">

                    <form method = "post" name = "user-avatar-change" id = "user-avatar-change"  onsubmit="return false;"
                          action = "{{ urlFor('user.profile.avatar-change.post') }}">
                        <div class = "inputs-container">

                            <div class = "vertical-section text-centered">
                                <div class = "inner-70pct">
                                    <input type="hidden" name="MAX_FILE_SIZE" value="2000000" />
                                    <input type="file" accept="image/jpeg,image/gif,image/png" tabindex="1"
                                           name="avatar-file" id="avatar-file" class = "file-input" required/>
                                    <div class = "file-div-cont upload">
                                        <label for = "avatar-file" class = "button-label">
                                            <span>Odaberite datoteku</span>
                                        </label>
                                        <label class = "selected-file">
                                            <span></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <script type="text/javascript">
                                $(document).on('change', '.file-input:file', function() {
                                    var input = $(this),
                                        numFiles = input.get(0).files ? input.get(0).files.length : 1,
                                        label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                                    input.trigger('fileselect', [numFiles, label]);
                                });

                                $(document).ready( function() {
                                    $('.file-input:file').on('fileselect', function(event, numFiles, label) {
                                        var input = $(this).parents('.vertical-section').find('.selected-file > span'),
                                            button = $(this).parents('.vertical-section').find('.button-label > span'),
                                            log = numFiles > 1 ? ' Odabranih datoteka: ' + numFiles : label;

                                        if( input.length ) {
                                            if(log === "") {
                                                input.html(log);
                                                button.text('Odaberite datoteku');
                                            } else {
                                                input.html('<i class = "fa fa-fw fa-file-image-o"></i> ' + log);
                                                button.text('Odabrano: ');
                                            }
                                        } else {
                                            if( log ) alert(log);
                                        }

                                    });
                                });
                            </script>


                            <div class = "vertical-section text-centered">
                                <div class = "inner-70pct">
                                    <input type="checkbox" name="delete-avatar" id="delete-avatar"
                                           class = "cb-input delete-avatar" tabindex="2">
                                    <div class = "checkbox-div-cont">
                                        <label for = "delete-avatar" alt="Samo izbriši" placeholder="Samo izbriši" data-info="Samo izbriši">
                                            <span>Samo izbriši?</span>
                                        </label>
                                    </div>
                                </div>

                            </div>




                        </div>

                        {% include "templates/partials/user_messages.twig" %}

                        {% include "templates/partials/live_status.container.twig" %}

                        <input type = "hidden" name = "{{ csrf_key }}" value = "{{ csrf_token }}">

                        <div class = "submitter-cont">
                            <div class = "inner-70pct">
                                <div class = "submitter submit bbb-flag-v-cibona-blue" tabindex="3"
                                     onclick="validateAndSubmitAvatarChange('user-avatar-change')">
                                    <span>SPREMI PROMJENU</span>
                                </div>
                                <div class="submitter bbb-flag-v-cibona-blue reversed cancel">
                                    <a href = "{{ urlFor('user.profile.home') }}" tabindex="4">ODUSTANI</a>
                                </div>
                            </div>
                        </div>

                    </form>

                </div>
            </div>
        </div>

    </div>



    <script>
        $(document).ready(function(){
            function valSub() {
                if(formSubmittingActive == true) {
                    validateAndSubmitAvatarChange('user-avatar-change');
                    return false;
                }
            }
            $('#user-avatar-change').keydown(function(e) {

                if (e.keyCode == 13) {
                    valSub();
                }
            });
            $('.submitter.submit').keydown(function(e) {

                if (e.keyCode == 13) {
                    valSub();
                }
            });
        });
    </script>
{% endblock %}